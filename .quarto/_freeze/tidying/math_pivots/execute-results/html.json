{
  "hash": "29ee5af2c2b35961a9ad9ec58fa305cd",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Pivoting data\nengine: knitr\nformat: live-html\nwebr:\n  packages:\n    - readr\n    - lubridate\n    - tidyr\n    - dplyr\n    - gradethis\n    - readxl\n    - janitor\n    - stringr\nresources:\n  - images\n  - data\n---\n\n::: {.cell}\n\n:::\n\n::: {.cell edit='false'}\n```{webr}\n#| edit: false\n#| output: false\nwebr::install(\"gradethis\", quiet = TRUE)\nlibrary(gradethis)\noptions(webr.exercise.checker = function(\n  label, user_code, solution_code, check_code, envir_result, evaluate_result,\n  envir_prep, last_value, engine, stage, ...\n) {\n  if (is.null(check_code)) {\n    # No grading code, so just skip grading\n    invisible(NULL)\n  } else if (is.null(label)) {\n    list(\n      correct = FALSE,\n      type = \"warning\",\n      message = \"All exercises must have a label.\"\n    )\n  } else if (is.null(solution_code)) {\n    list(\n      correct = FALSE,\n      type = \"warning\",\n      message = htmltools::tags$div(\n        htmltools::tags$p(\"A problem occurred grading this exercise.\"),\n        htmltools::tags$p(\n          \"No solution code was found. Note that grading exercises using the \",\n          htmltools::tags$code(\"gradethis\"),\n          \"package requires a model solution to be included in the document.\"\n        )\n      )\n    )\n  } else {\n    gradethis::gradethis_exercise_checker(\n      label = label, solution_code = solution_code, user_code = user_code,\n      check_code = check_code, envir_result = envir_result,\n      evaluate_result = evaluate_result, envir_prep = envir_prep,\n      last_value = last_value, stage = stage, engine = engine)\n  }\n})\n```\n:::\n\n::: {.cell}\n```{webr}\n#| include: false\n#| \n\n#designations <- readxl::read_excel(tf1)\n#df <- read_csv(\"https://www.fema.gov/api/open/v2/DisasterDeclarationsSummaries.csv\")\ndf <- read_csv(\"data/DisasterDeclarationsSummaries.csv\")\ncounty_pop <- read_csv(\"data/county_population.csv\")\n#county_pop <- read_csv(\"https://www.andrewbatran.com/data/county_population.csv\")\n\ndf_new <- df |> \n  mutate(GEOID=str_c(fipsStateCode, fipsCountyCode))\n\njoined_new <- left_join(df_new, county_pop, by=\"GEOID\")\n\n\nlong_flood <- joined_new |> \n  #filter(state==\"KY\") |> \n  filter(incidentType==\"Flood\") |> \n  mutate(year=year(incidentBeginDate)) |> \n  # extracting months\n  mutate(month=month(incidentBeginDate)) |> \n  # only paying attention to months in current year of data set\n  filter(month %in% c(1:8)) |> \n  filter(year==2020 | year==2021 | year==2022) |> \n  group_by(year, state) |> \n  summarize(declarations=n(),\n            avg_pop=mean(estimate, na.rm=T),\n            median_pop=median(estimate, na.rm=T))\n\nwide_flood <- long_flood |> \n  pivot_wider(names_from=\"year\",\n              values_from=\"declarations\")\n\n\nfires_wide <- joined_new |> \n  filter(incidentType==\"Fire\") |> \n  mutate(year=year(incidentBeginDate)) |> \n  count(year, NAME) |> \n  filter(!is.na(NAME)) |> \n  pivot_wider(names_from=\"year\", values_from=n)\n```\n:::\n\n::: {.cell edit='false' define='ok_reponse'}\n```{webr}\n#| edit: false\n#| output: false\n#| define:\n#|   - ok_reponse\nlibrary(htmltools)\nok_reponse <- function(reponse, n) {\n  if (is.na(reponse)) HTML(\"\")\n  else if (reponse == n) div(HTML(\"Correct ✓\"), style = \"color: green\")\n  else div(HTML(\"Incorrect ✗\"), style = \"color: red\")\n}\n```\n:::\n\n\n\n\n\n## tidyr\n\nYou need to understand the basics of math to tell a story.\n\nLet's say you're looking at this data because some local disaster occurred and you want to answer the question:\n\n* Are things worse now than they were before? \n* Which place has it worst and most recently? \n  * Because you can go visit that place and find victims to anchor the story narratively\n  \nBeing able to come up with types of questions and answer them yourself using raw data will help you stand apart from the competition. \n\nBecause you're working with raw data intended for use by an agency for one thing, you'll need to be able to reshape the data so you can do your own analysis, which will include math (such as difference, percents, percent change, and per capita).\n\nOne advanced technique for transforming data you'll learn in this section is from the **tidyr** package.\n\n* `pivot_wider()`\n* `pivot_longer()`\n\nNow, these used to be called `gather()` and `spread()` but the language is a bit clearer now.\n\nPivots in R mean something else entirely than pivots in Excel.\n\nIn Excel, pivot tables are used to group and summarize data.\n\nIn R, you pivot data as in you reshape it. This way you can do math easier across all rows.\n\nHere's how it works (pay attention to the colors):\n\n\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](images/tidyr-pivoting.gif){width=400px}\n:::\n:::\n\n\n\n\nLet's start with this data that we last ended up with. \n\nBut this time comment comment out the second line so we include all states with floods this time.\n\nAnd in the 10th line, add \"state\" as a second argument in the `group_by()` option after \"year\".\n\n::: {.panel-tabset}\n\n## Exercise\n\n\n\n\n::: {.cell exercise='what'}\n```{webr}\n#| exercise: what\nlong_flood <- joined_new |> \n  filter(incidentType==\"Flood\") |> \n  mutate(year=year(incidentBeginDate)) |> \n  # extracting months\n  mutate(month=month(incidentBeginDate)) |> \n  # only paying attention to months in current year of data set\n  filter(month %in% c(1:8)) |> \n  filter(year==2020 | year==2021 | year==2022) |> \n  group_by(year) |> \n  summarize(declarations=n(),\n            avg_pop=mean(estimate, na.rm=T),\n            median_pop=median(estimate, na.rm=T))\n\nlong_flood\n```\n:::\n\n\n\n\n## Hint\n\n::: {.hint exercise=\"what\"}\nUse a # to comment out.\nAlso, you don't need quotations around column names in\ngroup_by() unless there's a space in the column names.\nMultiple arguments in group_by() are separated by a comma.\n:::\n\n## Solution\n\n::: {.solution exercise=\"what\"}\n\n\n\n::: {.cell exercise='solution' solution='true'}\n```{webr}\n#| exercise: solution\n#| solution: true\nlong_flood <- joined_new |> \n  filter(incidentType==\"Flood\") |> \n  mutate(year=year(incidentBeginDate)) |> \n  # extracting months\n  mutate(month=month(incidentBeginDate)) |> \n  # only paying attention to months in current year of data set\n  filter(month %in% c(1:8)) |> \n  filter(year==2020 | year==2021 | year==2022) |> \n  group_by(year, state) |> \n  summarize(declarations=n(),\n            avg_pop=mean(estimate, na.rm=T),\n            median_pop=median(estimate, na.rm=T))\n\nlong_flood\n```\n:::\n\n::: {.cell exercise='what' check='true'}\n```{webr}\n#| exercise: what\n#| check: true\ngradethis::grade_this_code()\n```\n:::\n\n\n\n\n:::\n::::\n\nOkay, we have tidy data! Each variable is in its own column. Each case is in its own row and each value is in its own cell.\n\nThis makes it easier to mutate and manipulate (and is also the preferable data structure for most data viz tools).\n\nHowever, if we wanted to compare 2020 declaration counts to 2021 and 2022 in each state, that would be difficult.\n\n## pivot_wider()\n\nSo we need to turn this long data into wide data using `pivot_wider()`\n\nYou need to identify what column you want to pull the new column names from and which column the values are stored in (\"year\" and \"declarations\" respectively. In this specific circumstance (\"pivot_\") you'll need to put the column names in quotation marks.\n\nWe'll also need to drop the `avg_pop` and `median_pop` columns or else the pivot will fail.\n\nTo drop columns, you use the `-` subtract sign in the `select()` function.\n\n\n::: {.panel-tabset}\n\n## Exercise\n\n\n\n\n::: {.cell exercise='pivot_wider'}\n```{webr}\n#| exercise: pivot_wider\nwide_flood <- long_flood |> \n  select(-avg_pop, -median_pop) |> \n  pivot_wider(names_from=\"____\",\n              values_from=\"____________\")\n\nwide_flood\n```\n:::\n\n\n\n\n## Hint\n\n::: {.hint exercise=\"pivot_wider\"}\nIn this instance, you do need to put the column names in quotation marks.\n:::\n\n## Solution\n\n::: {.solution exercise=\"pivot_wider\"}\n\n\n\n::: {.cell exercise='pivot_wider' solution='true'}\n```{webr}\n#| exercise: pivot_wider\n#| solution: true\nwide_flood <- long_flood |> \n  select(-avg_pop, -median_pop) |> \n  pivot_wider(names_from=\"year\",\n              values_from=\"declarations\")\n\nwide_flood\n```\n:::\n\n::: {.cell exercise='pivot_wider' check='true'}\n```{webr}\n#| exercise: pivot_wider\n#| check: true\ngradethis::grade_this_code()\n```\n:::\n\n\n\n:::\n::::\n\nGreat job! We can clearly see most states had flooding in only one year. \n\nKentucky had 50 in 2021 and 20 in 2022 (Okay, the number may change in 2022 depending on when you pull this data and how unlucky Kentucky continues to be). \n\nWe knew that from our last section but now we can see that it's the only state that had floods in both years.\n\nBut we can now answer one of our questions:\n\n* Which place has it worst and most recently? \n\nIf you paginate through the results you'll see one state in particular went from no floods in 2021 to 19 in 2022.\n\nNext, we can use `summarize()` and `mutate()` to do some math to answer our first question:\n\n* Are things worse now than they were before? \n\nNote: Because the column names we care about starts with a number, we need to surround the column names ``like `this` in the code.`` The key to the left of the `1` on the keyboard. This is also what you'd have to do if the column names had spaces in them.\n\nAdd up all the floods by year with summarize and then add a column that calculates the percent change between 2022 and 2021.\n\nDon't forget to add the argument that ignores any `NA` values in the `sum()` formula.\n\n::: {.panel-tabset}\n\n## Exercise\n\n\n\n\n::: {.cell exercise='wide_flood_summary'}\n```{webr}\n#| exercise: wide_flood_summary\nflood_percent_change <- wide_flood |> \n  summarize(`2020`=sum(______, _____=T),\n            `2021`=sum(______, _____=T),\n            `2022`=sum(______, _____=T)) |> \n  ______(percent_change=(round((`____`-`____`)/`____`*100,1)))\n\nflood_percent_change\n```\n:::\n\n\n\n\n## Hint\n\n::: {.hint exercise=\"wide_flood_summary\"}\nThe formula for percent change is (new-old)/old*100. Also remember the differences between aggregating a data frame and adding a column to an existing data frame.\n:::\n\n## Solution\n\n::: {.solution exercise=\"wide_flood_summary\"}\n\n\n\n::: {.cell exercise='wide_flood_summary' solution='true'}\n```{webr}\n#| exercise: wide_flood_summary\n#| solution: true\nflood_percent_change <- wide_flood |> \n  summarize(`2020`=sum(`2020`, na.rm=T),\n            `2021`=sum(`2021`, na.rm=T),\n            `2022`=sum(`2022`, na.rm=T)) |> \n  mutate(percent_change=(round((`2022`-`2021`)/`2021`*100,1)))\n\nflood_percent_change\n```\n:::\n\n::: {.cell exercise='wide_flood_summary' check='true'}\n```{webr}\n#| exercise: wide_flood_summary\n#| check: true\ngradethis::grade_this_code()\n```\n:::\n\n\n\n:::\n::::\n\n## pivot_wider() multiple\n\nWhat's really powerful about `pivot_wider()` is the option to be able to draw values from more than one column.\n\nAdjust the code below:\n\n1. Delete the `-avg_pop` argument in line 2 (and the comma)\n2. in `values_from`, instead of \"declarations\" type in `c(\"declarations\", \"avg_pop\")\n\nSee what happens. *Also, type it in, don't copy and paste otherwise you'll run into syntax issues.*\n\n::: {.panel-tabset}\n\n## Exercise\n\n\n\n::: {.cell exercise='pivot_wider_more'}\n```{webr}\n#| exercise: pivot_wider_more\nwide_flood_more <- long_flood |> \n  select(-avg_pop, -median_pop) |> \n  pivot_wider(names_from=\"year\",\n              values_from=\"declarations\")\n\nwide_flood_more\n```\n:::\n\n\n\n\n## Hint\n\n::: {.hint exercise=\"pivot_wider_more\"}\nBe careful about syntax.\nAlso, you still want to pull names from \"year\"\n:::\n\n## Solution\n\n::: {.solution exercise=\"pivot_wider_more\"}\n\n\n\n::: {.cell exercise='pivot_wider_more' solution='true'}\n```{webr}\n#| exercise: pivot_wider_more\n#| solution: true\nwide_flood_more <- long_flood |> \n  select(-median_pop) |> \n  pivot_wider(names_from=\"year\",\n              values_from=c(\"declarations\", \"avg_pop\"))\n\nwide_flood_more\n```\n:::\n\n::: {.cell exercise='pivot_wider_more' solution='true'}\n```{webr}\n#| exercise: pivot_wider_more\n#| solution: true\ngradethis::grade_this_code()\n```\n:::\n\n\n\n\n:::\n::::\n\nYou'll have to paginate a bit but you can see that the declarations and average are now prefixes to the `_2021` etc years.\n\nYou could also bring in the median values this way if you want.\n\nOkay, now that we know how to make long data to wide, let's convert wide data to long.\n\n## pivot_longer()\n\nSometimes you'll get data that looks like this:\n\n\n\n\n::: {.cell}\n```{webr}\nfires_wide\n```\n:::\n\n\n\n\nThese are the declared fire disasters in each county since 1956.\n\nA state or column in one row and every column after is a different year of data.\n\nThis is not tidy data. Every year should be its own row. This is fine if we want to calculate changes between individual years.\n\nBut if we wanted to visualize this, we'd need to transform it long.\n\nWe want to increase the number of rows and decrease the number of columns.\n\nWe'll use the `pivot_longer()` function which needs:\n\n1. What columns to focus on `cols=`\n2. What to name the column with the names of the columns `names_to=`\n3. What to name the column with the values `values_to=`\n\n::: {.panel-tabset}\n\n## Exercise\n\n\n\n\n::: {.cell exercise='pivot_longer'}\n```{webr}\n#| exercise: pivot_longer\n# We could do cols=`1967`:`2022`\n# or we could do the number of columns in the dataframe as in cols=2:41\n# let's do the first option in this one\n\nfires_wide |> \n  pivot_______(cols=_____________,\n               _____to=\"year\",\n               _______to=\"declarations\")\n  \n```\n:::\n\n\n\n\n## Hint\n\n::: { .hint exercise=\"pivot_longer\"}\nMake sure you name the arguments correctly.\n:::\n\n## Solution\n\n::: { .solution exercise=\"pivot_longer\"}\n\n\n\n\n::: {.cell exercise='pivot_longer' solution='true'}\n```{webr}\n#| exercise: pivot_longer\n#| solution: true\nfires_wide |> \n  pivot_longer(cols=`1967`:`2022`,\n               names_to=\"year\",\n               values_to=\"declarations\")\n```\n:::\n\n::: {.cell exercise='pivot_longer' check='true'}\n```{webr}\n#| exercise: pivot_longer\n#| check: true\ngradethis::grade_this_code()\n```\n:::\n\n\n\n:::\n::::\n\nAlright! We did it!\n\nYou now have a handle on all the biggest verbs used to wrangle and transform data.\n\nThere are many more functions that do more specific things, of course.\n\nBut this will hopefully get you started on your way. Everything else you may have questions on how to do has probably been asked and answered out in the R online community.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}